# Place to store backups. 
Running the back up script will place the elasticsearch data in here. 


# To run snapshot from dev console with the api use the following; 
```json
PUT _snapshot/pilot_image_backup
{
  "type": "fs",
  "settings": {
    "location": "/usr/share/elasticsearch/data/snapshots/pilot_image_backup"
  }
}
```

### Useful Kibana dev console commands
```bash


####################################################################
# SNAPSHOT & RESTORE                                               #
####################################################################

# CREATE SNAPSHOT Repository
PUT _snapshot/pilot_image_backup
{
  "type": "fs",
  "settings": {
    "location": "/usr/share/elasticsearch/data/snapshots/pilot_image_backup"
  }
}

# CREATE SNAPSHOT
PUT /_snapshot/pilot_image_backup/20230623_demo_snapshot?wait_for_completion=true&pretty

# Print the snapshot
GET /_snapshot/pilot_image_backup/*?pretty&verbose=false

## Print all snapshots
GET /_snapshot?pretty

# Restore snapshot
GET /_snapshot/pilot_image_backup/20230623_demo_snapshot/_restore
####################################################################

####################################################################
# Search                                                           #
####################################################################

# Create the index
PUT /academic-images

# Delete Index 
DELETE /academic-images

# Put a mapping for an index.
GET /academic-images/_mapping

## Get the image counts 
GET /academic-images/_count

# Get all the docs in index
GET /academic-images/_search 
{ 
  "query": {
     "match_all": {}
} 

# Check if any are missing an embedding.
# Helpful for shard failures to check data consitency.
GET /academic-images/_search
{
  "query": {
    "bool": {
      "must_not": {
        "exists": {
            "field": "imageEmbedding"
        }
      }
    }
  }
}

# Probably won't ever need this again but its a good reference 
# for if a mapping ever changes how to handle miss names.
POST academic-images/_update_by_query?conflicts=proceed
{
  "script": "ctx._source.remove('imageEmbeddings')",
  "query": {
    "bool": {
      "must": [
        {
          "exists": {
            "field": "image_embedding"
          }
        }
      ]
    }
  }
}

# Search for document with the given id.
GET /academic-images/_search 
{ 
  "query": {
      "wildcard": {
        "image_id":  "W03-171*"
      }
  } 
}

# Delete a doc.
DELETE /academic-images/_doc/I11-1130.pdf-Table3


# Multi classification search.
POST /academic-images/_search
{
    "query": {
      "bool": {
        "must": [
          {
            "nested": {
              "path": "predictions",
              "query": {
                "bool": {
                  "must": [
                    {
                      "match": {
                        "predictions.label": "scatter plot"
                      }
                    }
                  ]
                }
              }
            }
          },
          {
            "nested": {
              "path": "predictions",
              "query": {
                "bool": {
                  "must": [
                    {
                      "match": {
                        "predictions.label": "box plot"
                      }
                    }
                  ]
                }
              }
            }
          }
        ]
      }
    },
    "sort": [
      {
        "predictions.confidence": {
            "mode" :  "min",
            "order" : "desc",
            "nested": {
               "path": "predictions",
               "filter": {
                  "terms":
                  {"predictions.label":
                    ["scatter plot", "box plot"]}
               }
            }
        }
      }
    ]
}


/**

  "sort": [
      {
        "predictions.confidence": {
            "mode" :  "min",
            "order" : "desc",
            "nested": {
               "path": "predictions",
               "filter": {
                  "terms":
                  {"predictions.label":
                    ["scatter plot"]}
               }
            }
        }
      }
    ]
    */

# Search by one classification and sort the highest with the same classification.
POST /academic-images/_search
{
    "query": {
      "nested": {
        "path": "predictions",
        "query": {
          "bool": {
            "must": [
             {
                "match": {
                  "predictions.label": "scatter plot"
                }
              }
            ]
          }
        }
      }
    },
    "sort": [
      {
        "predictions.confidence": {
            "mode" :  "min",
            "order" : "desc",
            "nested": {
               "path": "predictions",
               "filter": {
                  "terms":
                  {"predictions.label":
                    ["scatter plot", "graph"]}
               }
            }
        }
      }
    ]
}

GET /academic-images/_search
{
  "query": {
    "term": {
      "predictions.predictions.label": {
        "value": "scatter plot"
      }
    }
  }
}

# Script search with classification
GET /academic-images/_search
{
  "size": 1,
  "query": {
    "script_score": {
      "query": {
        "bool": {
          "must": [
             {
            "nested": {
              "path": "predictions",
              "query": {
                "bool": {
                  "must": [
                    {
                      "match": {
                        "predictions.label": "scatter plot"
                      }
                    }
                  ]
                }
              }
            }
          },
          {
            "nested": {
              "path": "predictions",
              "query": {
                "bool": {
                  "must": [
                    {
                      "match": {
                        "predictions.label": "box plot"
                      }
                    }
                  ]
                }
              }
            }
          }
          ]
        }
      },
      "script": {
        "source": 
        "cosineSimilarity(params.queryVector, 'embedding')+1.0",
        "params": {
          "queryVector": [
            0.4062674045562744,
            -0.31361597776412964,
            -0.07097271829843521,
            -0.1414298415184021,
            -0.54490727186203,
            -0.3862650394439697,
            0.15235885977745056,
            0.210875004529953,
            0.506184995174408,
            -0.07840768992900848,
            0.15128715336322784,
            0.2388533651828766,
            -0.9134112596511841,
            0.3164702355861664,
            0.026417484506964684,
            0.13785651326179504,
            -0.1145240068435669,
            0.22212009131908417,
            -0.31371480226516724,
            0.5547974109649658,
            -0.15565308928489685,
            -0.16300147771835327,
            -0.11164721846580505,
            0.2220453917980194,
            0.011302385479211807,
            0.41445857286453247,
            -0.061157360672950745,
            -0.043436381965875626,
            -0.10889473557472229,
            -0.7783347964286804,
            0.16759388148784637,
            -0.15923228859901428,
            0.011835068464279175,
            0.38159579038619995,
            0.8196347951889038,
            0.37949272990226746,
            -0.07689470797777176,
            0.44252753257751465,
            -0.06952371448278427,
            -1.8120496273040771,
            -0.13305291533470154,
            0.5462177991867065,
            -0.27799367904663086,
            -0.19108757376670837,
            -0.033658143132925034,
            -1.4523550271987915,
            -0.44329699873924255,
            0.1918838918209076,
            0.13936883211135864,
            0.14015614986419678,
            -0.08816364407539368,
            -0.2274290919303894,
            -0.06803937256336212,
            -0.3610597848892212,
            -0.22197823226451874,
            0.0036016982048749924,
            -0.46346184611320496,
            0.4408992528915405,
            0.0026393160223960876,
            0.17131207883358002,
            0.30885595083236694,
            0.054572250694036484,
            -0.07762967050075531,
            -0.14117030799388885,
            0.11746025085449219,
            -0.08233463019132614,
            -0.1532215178012848,
            0.47683247923851013,
            -0.5815709233283997,
            -0.1874835044145584,
            0.07022187113761902,
            0.09467673301696777,
            -0.0699491947889328,
            -0.4027368128299713,
            0.12053698301315308,
            0.10124826431274414,
            0.46585848927497864,
            -0.4807508587837219,
            -0.1856912523508072,
            -0.4464399218559265,
            -0.5420911312103271,
            -0.18009871244430542,
            0.17373108863830566,
            1.1117719411849976,
            -0.03817547857761383,
            0.36997073888778687,
            1.655663013458252,
            -0.2764865756034851,
            0.48931214213371277,
            0.2740077078342438,
            -0.028302578255534172,
            -0.22192415595054626,
            -5.481080055236816,
            0.3121049702167511,
            0.18416593968868256,
            0.23920586705207825,
            -0.054541684687137604,
            -0.5703620910644531,
            -0.09601233154535294,
            -0.1996627300977707,
            -0.03218044713139534,
            -0.6912479400634766,
            0.09683891385793686,
            0.1329173743724823,
            -0.19586217403411865,
            0.02243417501449585,
            -2.748929738998413,
            -0.12009219825267792,
            0.25147730112075806,
            -0.0992431789636612,
            -0.37616994976997375,
            -0.5326975584030151,
            -0.515141487121582,
            0.14230510592460632,
            -0.20555779337882996,
            0.16163858771324158,
            -0.058530837297439575,
            -0.7004193067550659,
            -0.2749241590499878,
            -0.14984719455242157,
            0.052521683275699615,
            0.0531843900680542,
            0.010581403970718384,
            0.3029480576515198,
            -0.346346378326416,
            -0.13221335411071777,
            -0.20659524202346802,
            -0.04053960740566254,
            -0.2436092346906662,
            0.5597805380821228,
            0.45997679233551025,
            0.16799110174179077,
            0.02186805009841919,
            0.7107443809509277,
            0.06869445741176605,
            -0.03345712274312973,
            0.1000632643699646,
            -0.5967581272125244,
            0.3331429958343506,
            -0.08266894519329071,
            -0.30302393436431885,
            -0.23147661983966827,
            -0.4693082571029663,
            -0.277568519115448,
            -0.05644955486059189,
            -0.010810291394591331,
            0.1838393360376358,
            0.27629804611206055,
            0.2456856667995453,
            -0.1609152853488922,
            0.1544085144996643,
            -0.030174843966960907,
            0.2315036654472351,
            -0.03390447050333023,
            0.10468010604381561,
            -0.6452053785324097,
            0.003331601619720459,
            -0.05879972130060196,
            0.4841797649860382,
            0.17976823449134827,
            0.4356115162372589,
            -0.24922619760036469,
            0.1842162311077118,
            -0.11946957558393478,
            0.7591691613197327,
            -0.21046561002731323,
            -0.2762138247489929,
            -0.25271472334861755,
            0.22474071383476257,
            0.12536071240901947,
            -0.3766239881515503,
            -0.18918626010417938,
            -0.463556706905365,
            -0.21486079692840576,
            -0.09306824207305908,
            -0.02387753129005432,
            -0.8354854583740234,
            0.3232971429824829,
            0.7261736392974854,
            0.24860969185829163,
            0.44993916153907776,
            -0.339258074760437,
            -0.8492785692214966,
            0.26390933990478516,
            0.2180342674255371,
            -0.22044488787651062,
            0.3265281617641449,
            0.6944353580474854,
            -0.05265527591109276,
            -0.15234719216823578,
            0.08124411106109619,
            -0.03665449842810631,
            -0.2102554887533188,
            -0.07830430567264557,
            -0.24063317477703094,
            0.2145180106163025,
            0.4252358675003052,
            0.17940156161785126,
            0.2866237759590149,
            0.13246846199035645,
            0.39158523082733154,
            -0.4615260362625122,
            -0.29435452818870544,
            -0.7219625115394592,
            0.02410797029733658,
            0.2098122239112854,
            -0.1791355013847351,
            0.03959481790661812,
            0.5686483979225159,
            0.16394922137260437,
            -0.26215192675590515,
            0.383989155292511,
            -0.22485065460205078,
            0.22211791574954987,
            0.12077076733112335,
            -0.18684792518615723,
            -0.08172030746936798,
            0.9005330204963684,
            -0.1616525799036026,
            -0.2390272170305252,
            0.18910819292068481,
            0.8509576916694641,
            -0.01201116107404232,
            0.07929819077253342,
            0.28378212451934814,
            -0.7146619558334351,
            0.12219126522541046,
            0.21430930495262146,
            0.12731261551380157,
            0.5355793833732605,
            -0.5966141819953918,
            -0.04745461791753769,
            0.1722126305103302,
            0.010688364505767822,
            -0.37507060170173645,
            -0.7476760149002075,
            -0.10561272501945496,
            -0.4595065712928772,
            0.0030943304300308228,
            0.30402490496635437,
            -0.09527140855789185,
            0.06391678750514984,
            -0.1527070701122284,
            0.03364500403404236,
            -0.23991596698760986,
            0.22027340531349182,
            0.16999030113220215,
            0.08200447261333466,
            0.3075256049633026,
            0.2265360951423645,
            -0.39838141202926636,
            -0.3167780935764313,
            0.05428963154554367,
            0.15308314561843872,
            -0.41406160593032837,
            0.1280762106180191,
            -0.09017550945281982,
            0.007112607359886169,
            -1.2357865571975708,
            -0.1434277594089508,
            -0.039858780801296234,
            0.3258647322654724,
            -0.027418330311775208,
            0.596511960029602,
            -0.47972774505615234,
            0.042004168033599854,
            -0.31681355834007263,
            -0.1336369514465332,
            0.2936711013317108,
            0.3264976739883423,
            -0.5587578415870667,
            -0.19027727842330933,
            0.16848160326480865,
            -0.4269479215145111,
            0.45937418937683105,
            -0.013887390494346619,
            -0.02565978839993477,
            0.1244363784790039,
            0.5426083207130432,
            0.15777114033699036,
            0.6709981560707092,
            0.5206882357597351,
            -0.12381823360919952,
            -0.24701358377933502,
            0.011059805750846863,
            0.5916118621826172,
            -0.7063388228416443,
            0.1677534282207489,
            -0.060854721814394,
            0.0736236572265625,
            -0.10950174927711487,
            -0.20645543932914734,
            0.3290364444255829,
            0.08791408687829971,
            0.17372778058052063,
            0.3286347985267639,
            -0.4310137629508972,
            -0.3190089166164398,
            0.012095607817173004,
            0.24173732101917267,
            0.10463041067123413,
            -0.3162503242492676,
            -0.15304039418697357,
            0.4620661437511444,
            -0.29970794916152954,
            0.11661988496780396,
            0.23674649000167847,
            0.12384310364723206,
            0.42667824029922485,
            0.4262436032295227,
            -0.3312056064605713,
            0.22424839437007904,
            0.7104595899581909,
            0.6487482190132141,
            -0.33927857875823975,
            0.21034030616283417,
            0.04121465981006622,
            0.2572230398654938,
            -0.648535966873169,
            0.04123992100358009,
            0.6559778451919556,
            0.5085310935974121,
            -0.0009522773325443268,
            0.22966820001602173,
            -0.8338618874549866,
            -0.07959990203380585,
            -0.08740885555744171,
            -0.30628466606140137,
            0.4513559341430664,
            -0.4388582408428192,
            -0.15768307447433472,
            0.07852441072463989,
            0.5556638240814209,
            -0.0015397504903376102,
            -0.14854660630226135,
            -0.23486003279685974,
            -0.09653215855360031,
            0.6585909128189087,
            0.1386377364397049,
            0.24287739396095276,
            0.19509896636009216,
            -0.6939101815223694,
            -0.22979474067687988,
            0.32200586795806885,
            -0.04498228430747986,
            -0.15690258145332336,
            0.15697485208511353,
            -0.03480193018913269,
            0.15483155846595764,
            -0.014564136043190956,
            -0.020984061062335968,
            0.1583346575498581,
            0.1766972839832306,
            -0.29705649614334106,
            -0.22558321058750153,
            0.2841961085796356,
            0.24254457652568817,
            -0.9802015423774719,
            -0.2257167398929596,
            -0.09533245861530304,
            0.8677224516868591,
            -0.04511985927820206,
            0.3652912378311157,
            -0.003403151873499155,
            -1.068534016609192,
            0.3051936626434326,
            -0.1433684080839157,
            0.037116289138793945,
            0.6620926856994629,
            0.4130166172981262,
            -0.28171825408935547,
            -0.3602548837661743,
            -0.00840180367231369,
            0.16842733323574066,
            0.13383400440216064,
            -0.09104055911302567,
            -0.836675226688385,
            0.027606450021266937,
            -0.42633911967277527,
            -0.16248315572738647,
            -0.4537369906902313,
            -0.2821619212627411,
            -0.7106258273124695,
            -0.07542809844017029,
            -0.1152200922369957,
            0.35465720295906067,
            0.3677874207496643,
            -0.25493380427360535,
            -0.22603434324264526,
            0.9745941162109375,
            -0.5071500539779663,
            0.2984839081764221,
            -0.1167750433087349,
            -0.3650710880756378,
            -0.44132864475250244,
            0.5902950167655945,
            -0.7452888488769531,
            -0.29852136969566345,
            -0.08730161190032959,
            0.06805438548326492,
            -0.06568825244903564,
            -0.020377034321427345,
            -0.6315146684646606,
            -0.38243356347084045,
            0.17807814478874207,
            -0.09943889826536179,
            -0.16882579028606415,
            0.0009203627705574036,
            0.7583445906639099,
            -0.15716955065727234,
            0.085367351770401,
            -0.5484914183616638,
            -0.3251698315143585,
            -0.2585839033126831,
            0.11448273062705994,
            0.17458176612854004,
            0.22201451659202576,
            -0.00791032612323761,
            -0.09712199866771698,
            -0.31460607051849365,
            -0.08589775115251541,
            -0.40051087737083435,
            -0.09604144096374512,
            -0.8079922795295715,
            0.25405246019363403,
            0.1524694859981537,
            0.13739325106143951,
            -0.25853851437568665,
            -1.996300220489502,
            -0.28878751397132874,
            -0.07199634611606598,
            0.03153146803379059,
            -1.0363737344741821,
            -0.5038159489631653,
            -0.19156640768051147,
            0.390818327665329,
            -0.21196886897087097,
            -0.2945042848587036,
            0.3701692819595337,
            -0.7103577852249146,
            0.6075848937034607,
            -0.21287883818149567,
            0.1386491060256958,
            0.3047664165496826,
            0.016694437712430954,
            -0.3779181241989136,
            0.5239362120628357,
            -0.17761525511741638,
            -0.12486805021762848,
            0.511355996131897,
            0.09615565091371536,
            -0.3438100814819336,
            0.28024861216545105,
            -0.4508472979068756,
            0.16753984987735748,
            0.5951086282730103,
            -0.32496345043182373,
            0.10499399900436401,
            -0.33607542514801025,
            0.6539877653121948,
            0.07197999209165573,
            -0.1840553879737854,
            0.027421876788139343,
            -0.3717685341835022,
            -0.2393500655889511,
            -0.1565336138010025,
            0.1184229850769043,
            -0.11406825482845306,
            0.4199012517929077,
            0.23022626340389252,
            0.21468022465705872,
            -0.10911667346954346,
            -0.05874940752983093,
            -0.3565124571323395,
            -0.02051018923521042,
            -0.291077196598053,
            0.4172217547893524,
            -0.3270532488822937,
            -0.17336784303188324,
            0.10411466658115387,
            0.4989871382713318,
            0.07861396670341492,
            0.00982477143406868,
            0.10669095069169998,
            0.6136502623558044,
            -0.21402758359909058,
            -0.12296199798583984,
            0.10476359724998474,
            -0.3510228395462036,
            -0.42237040400505066,
            0.48261988162994385,
            -0.13680852949619293,
            0.27089497447013855,
            0.008820995688438416,
            0.417224645614624,
            0.061525482684373856,
            -0.030050266534090042,
            -0.36324048042297363,
            0.18308673799037933,
            -0.19690150022506714,
            -0.5944995284080505,
            0.3794081211090088,
            -0.23356038331985474,
            0.34740975499153137,
            -0.10036340355873108,
            -0.08071095496416092,
            -0.4356142580509186,
            -0.003512013703584671,
            -0.351752907037735,
            0.9546037912368774,
            -0.08284756541252136,
            -0.01236274465918541
          ]
        }
      }
    }
  }
}
```